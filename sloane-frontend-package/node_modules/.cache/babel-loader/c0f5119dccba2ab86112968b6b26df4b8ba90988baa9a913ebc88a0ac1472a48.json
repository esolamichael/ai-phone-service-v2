{"ast":null,"code":"// src/api/index.js\nimport axios from'axios';import authApi from'./auth';// Create axios instance with default config\nconst api=axios.create({baseURL:process.env.REACT_APP_API_URL||'https://fluted-mercury-455419-n0.uc.r.appspot.com/api',headers:{'Content-Type':'application/json'}});// Flag to prevent multiple refresh token requests\nlet isRefreshing=false;// Queue of failed requests to retry after token refresh\nlet failedQueue=[];// Process failed queue\nconst processQueue=function(error){let token=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;failedQueue.forEach(prom=>{if(error){prom.reject(error);}else{prom.resolve(token);}});failedQueue=[];};// Add request interceptor to include auth token\napi.interceptors.request.use(config=>{const token=localStorage.getItem('token');if(token){config.headers.Authorization=`Bearer ${token}`;}return config;},error=>{return Promise.reject(error);});// Add response interceptor to handle common errors\napi.interceptors.response.use(response=>{return response;},async error=>{var _error$response,_error$response$data;const originalRequest=error.config;// Handle 401 Unauthorized errors (token expired or invalid)\nif(error.response&&error.response.status===401&&!originalRequest._retry){// If token refresh already in progress, queue this request\nif(isRefreshing){return new Promise((resolve,reject)=>{failedQueue.push({resolve,reject});}).then(token=>{originalRequest.headers['Authorization']=`Bearer ${token}`;return api(originalRequest);}).catch(err=>{return Promise.reject(err);});}originalRequest._retry=true;isRefreshing=true;try{// Don't use authApi here to avoid circular dependency\n// Direct axios call to refresh token\nconst refreshToken=localStorage.getItem('refreshToken');if(!refreshToken){// If no refresh token, clear auth and redirect to login\nlocalStorage.removeItem('token');localStorage.removeItem('refreshToken');if(window.location.pathname!=='/login'){window.location.href='/login';}return Promise.reject(error);}const response=await axios.post(`${api.defaults.baseURL}/auth/refresh-token`,{refreshToken},{headers:{'Content-Type':'application/json'}});if(response.data.token){localStorage.setItem('token',response.data.token);if(response.data.refreshToken){localStorage.setItem('refreshToken',response.data.refreshToken);}api.defaults.headers.common['Authorization']=`Bearer ${response.data.token}`;originalRequest.headers['Authorization']=`Bearer ${response.data.token}`;// Process any queued requests\nprocessQueue(null,response.data.token);return api(originalRequest);}}catch(refreshError){// Token refresh failed, clear auth and redirect to login\nprocessQueue(refreshError,null);localStorage.removeItem('token');localStorage.removeItem('refreshToken');if(window.location.pathname!=='/login'){window.location.href='/login';}}finally{isRefreshing=false;}}// Format error message\nconst errorMessage=((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.message)||error.message||'An unexpected error occurred';return Promise.reject(new Error(errorMessage));});export default api;","map":{"version":3,"names":["axios","authApi","api","create","baseURL","process","env","REACT_APP_API_URL","headers","isRefreshing","failedQueue","processQueue","error","token","arguments","length","undefined","forEach","prom","reject","resolve","interceptors","request","use","config","localStorage","getItem","Authorization","Promise","response","_error$response","_error$response$data","originalRequest","status","_retry","push","then","catch","err","refreshToken","removeItem","window","location","pathname","href","post","defaults","data","setItem","common","refreshError","errorMessage","message","Error"],"sources":["/Users/Mike/Documents/ai-phone-service-codebase-v2/sloane-frontend-package/src/api/index.js"],"sourcesContent":["// src/api/index.js\nimport axios from 'axios';\nimport authApi from './auth';\n\n// Create axios instance with default config\nconst api = axios.create({\n  baseURL: process.env.REACT_APP_API_URL || 'https://fluted-mercury-455419-n0.uc.r.appspot.com/api',\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\n\n// Flag to prevent multiple refresh token requests\nlet isRefreshing = false;\n// Queue of failed requests to retry after token refresh\nlet failedQueue = [];\n\n// Process failed queue\nconst processQueue = (error, token = null) => {\n  failedQueue.forEach(prom => {\n    if (error) {\n      prom.reject(error);\n    } else {\n      prom.resolve(token);\n    }\n  });\n  \n  failedQueue = [];\n};\n\n// Add request interceptor to include auth token\napi.interceptors.request.use(\n  (config) => {\n    const token = localStorage.getItem('token');\n    if (token) {\n      config.headers.Authorization = `Bearer ${token}`;\n    }\n    return config;\n  },\n  (error) => {\n    return Promise.reject(error);\n  }\n);\n\n// Add response interceptor to handle common errors\napi.interceptors.response.use(\n  (response) => {\n    return response;\n  },\n  async (error) => {\n    const originalRequest = error.config;\n    \n    // Handle 401 Unauthorized errors (token expired or invalid)\n    if (error.response && error.response.status === 401 && !originalRequest._retry) {\n      // If token refresh already in progress, queue this request\n      if (isRefreshing) {\n        return new Promise((resolve, reject) => {\n          failedQueue.push({ resolve, reject });\n        })\n          .then(token => {\n            originalRequest.headers['Authorization'] = `Bearer ${token}`;\n            return api(originalRequest);\n          })\n          .catch(err => {\n            return Promise.reject(err);\n          });\n      }\n\n      originalRequest._retry = true;\n      isRefreshing = true;\n      \n      try {\n        // Don't use authApi here to avoid circular dependency\n        // Direct axios call to refresh token\n        const refreshToken = localStorage.getItem('refreshToken');\n        \n        if (!refreshToken) {\n          // If no refresh token, clear auth and redirect to login\n          localStorage.removeItem('token');\n          localStorage.removeItem('refreshToken');\n          if (window.location.pathname !== '/login') {\n            window.location.href = '/login';\n          }\n          return Promise.reject(error);\n        }\n\n        const response = await axios.post(\n          `${api.defaults.baseURL}/auth/refresh-token`,\n          { refreshToken },\n          { headers: { 'Content-Type': 'application/json' } }\n        );\n\n        if (response.data.token) {\n          localStorage.setItem('token', response.data.token);\n          if (response.data.refreshToken) {\n            localStorage.setItem('refreshToken', response.data.refreshToken);\n          }\n          \n          api.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;\n          originalRequest.headers['Authorization'] = `Bearer ${response.data.token}`;\n          \n          // Process any queued requests\n          processQueue(null, response.data.token);\n          \n          return api(originalRequest);\n        }\n      } catch (refreshError) {\n        // Token refresh failed, clear auth and redirect to login\n        processQueue(refreshError, null);\n        localStorage.removeItem('token');\n        localStorage.removeItem('refreshToken');\n\n        if (window.location.pathname !== '/login') {\n          window.location.href = '/login';\n        }\n      } finally {\n        isRefreshing = false;\n      }\n    }\n    \n    // Format error message\n    const errorMessage = \n      error.response?.data?.message || \n      error.message || \n      'An unexpected error occurred';\n    \n    return Promise.reject(new Error(errorMessage));\n  }\n);\n\nexport default api;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}